"use strict";(self.webpackChunkguide=self.webpackChunkguide||[]).push([[686],{3905:function(e,t,n){n.d(t,{Zo:function(){return c},kt:function(){return h}});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function i(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function o(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?i(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):i(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)n=i[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var p=a.createContext({}),l=function(e){var t=a.useContext(p),n=t;return e&&(n="function"==typeof e?e(t):o(o({},t),e)),n},c=function(e){var t=l(e.components);return a.createElement(p.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},u=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,p=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),u=l(n),h=r,k=u["".concat(p,".").concat(h)]||u[h]||d[h]||i;return n?a.createElement(k,o(o({ref:t},c),{},{components:n})):a.createElement(k,o({ref:t},c))}));function h(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=u;var s={};for(var p in t)hasOwnProperty.call(t,p)&&(s[p]=t[p]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var l=2;l<i;l++)o[l]=n[l];return a.createElement.apply(null,o)}return a.createElement.apply(null,n)}u.displayName="MDXCreateElement"},9043:function(e,t,n){n.r(t),n.d(t,{assets:function(){return c},contentTitle:function(){return p},default:function(){return h},frontMatter:function(){return s},metadata:function(){return l},toc:function(){return d}});var a=n(7462),r=n(3366),i=(n(7294),n(3905)),o=["components"],s={},p="handling the access token",l={unversionedId:"oauth/access-token",id:"oauth/access-token",title:"handling the access token",description:"overview",source:"@site/docs/oauth/access-token.md",sourceDirName:"oauth",slug:"/oauth/access-token",permalink:"/guide/oauth/access-token",editUrl:"https://github.com/d2api/d2api.github.io/tree/docs-src/docs/oauth/access-token.md",tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"OAuth",permalink:"/guide/oauth/"},next:{title:"weird OAuth cases",permalink:"/guide/oauth/weird-cases"}},c={},d=[{value:"overview",id:"overview",level:2},{value:"issuing a new access token",id:"issuing-a-new-access-token",level:2},{value:"requesting the token",id:"requesting-the-token",level:3},{value:"receiving the token data",id:"receiving-the-token-data",level:3},{value:"using the access token",id:"using-the-access-token",level:2},{value:"refreshing the access token",id:"refreshing-the-access-token",level:2}],u={toc:d};function h(e){var t=e.components,n=(0,r.Z)(e,o);return(0,i.kt)("wrapper",(0,a.Z)({},u,n,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("h1",{id:"handling-the-access-token"},"handling the access token"),(0,i.kt)("h2",{id:"overview"},"overview"),(0,i.kt)("p",null,"an ",(0,i.kt)("inlineCode",{parentName:"p"},"access\xa0token")," is used to do authenticated requests.\nit's a string that looks like this:",(0,i.kt)("br",{parentName:"p"}),"\n",(0,i.kt)("inlineCode",{parentName:"p"},"Jq+R9ULSA1VWPGB/TBTDcuUcFJiI2Du/Cj8KUkQqkyXFGsAwwT7MakG/3ntvZNHrPHz="),(0,i.kt)("br",{parentName:"p"}),"\n","(the refresh token looks like this too)"),(0,i.kt)("h2",{id:"issuing-a-new-access-token"},"issuing a new access token"),(0,i.kt)("h3",{id:"requesting-the-token"},"requesting the token"),(0,i.kt)("p",null,"after performing the first part of the OAuth flow, the user is returned to your app with an ",(0,i.kt)("inlineCode",{parentName:"p"},"authorization\xa0code"),".",(0,i.kt)("br",{parentName:"p"}),"\n","this is a single string that proves to Bungie.net the user approved the login.",(0,i.kt)("br",{parentName:"p"}),"\n","it's used to complete the process and gets exchanged for an ",(0,i.kt)("inlineCode",{parentName:"p"},"access\xa0token"),"."),(0,i.kt)("p",null,"to get the ",(0,i.kt)("inlineCode",{parentName:"p"},"access\xa0token"),", send a POST request to the endpoint at\n",(0,i.kt)("inlineCode",{parentName:"p"},"https://www.bungie.net/platform/app/oauth/token/")),(0,i.kt)("p",null,"the goal is to send 4 pieces of information to the server, using form encoding"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"grant_type"),' - always "authorization_code". just those 2 literal words and an underscore '),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"code")," - the actual ",(0,i.kt)("inlineCode",{parentName:"li"},"authorization\xa0code")," provided by bungie"),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"client_id")," - from your ",(0,i.kt)("a",{parentName:"li",href:"/api/app-setup"},"application's details")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"client_secret")," - from your ",(0,i.kt)("a",{parentName:"li",href:"/api/app-setup"},"application's details"),".",(0,i.kt)("br",{parentName:"li"}),"or don't include this if you aren't using Confidential")),(0,i.kt)("p",null,"depending on your http or REST library, it may be able to encode this for you and send appropriate headers.  "),(0,i.kt)("p",null,"otherwise, you'll need to"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},"set a header with the name",(0,i.kt)("br",{parentName:"li"}),(0,i.kt)("inlineCode",{parentName:"li"},"Content-Type"),(0,i.kt)("br",{parentName:"li"}),"and the value",(0,i.kt)("br",{parentName:"li"}),(0,i.kt)("inlineCode",{parentName:"li"},"application/x-www-form-urlencoded")),(0,i.kt)("li",{parentName:"ul"},"send a POST body that looks like\n",(0,i.kt)("inlineCode",{parentName:"li"},"grant_type=authorization_code&code=8c66f9e519b7ec8498c8b4&client_id=123457&client_secret=TqlCb4VTZc89.7NKgBp9eFgjNb"),(0,i.kt)("br",{parentName:"li"}),"this is the above data, encoded as form fields")),(0,i.kt)("h3",{id:"receiving-the-token-data"},"receiving the token data"),(0,i.kt)("p",null,"more information on access token data ",(0,i.kt)("a",{parentName:"p",href:"/data-structures/access-token"},"here")),(0,i.kt)("p",null,"your application should ",(0,i.kt)("strong",{parentName:"p"},"save")," the ",(0,i.kt)("inlineCode",{parentName:"p"},"access_token")," and ",(0,i.kt)("inlineCode",{parentName:"p"},"refresh_token"),".",(0,i.kt)("br",{parentName:"p"}),"\n","we need these strings until the next refresh."),(0,i.kt)("p",null,"your application should calculate and ",(0,i.kt)("strong",{parentName:"p"},"save")," the time then the ",(0,i.kt)("inlineCode",{parentName:"p"},"access_token")," will expire.",(0,i.kt)("br",{parentName:"p"}),"\n",(0,i.kt)("inlineCode",{parentName:"p"},"expires_in")," says how many seconds until that happens, so add those seconds to the current datetime.  "),(0,i.kt)("p",null,"so if ",(0,i.kt)("inlineCode",{parentName:"p"},"expires_in")," says ",(0,i.kt)("inlineCode",{parentName:"p"},"3600")," seconds, then if you need to make another request more than 1 hour from right now, you should refresh the token instead of trying to use it."),(0,i.kt)("p",null,"your application should calculate and ",(0,i.kt)("strong",{parentName:"p"},"save")," the time then the ",(0,i.kt)("inlineCode",{parentName:"p"},"refresh_token")," will expire.",(0,i.kt)("br",{parentName:"p"}),"\n",(0,i.kt)("inlineCode",{parentName:"p"},"refresh_expires_in")," says how many seconds until that happens, so add those seconds to the current datetime.  "),(0,i.kt)("p",null,"so if ",(0,i.kt)("inlineCode",{parentName:"p"},"refresh_expires_in")," says ",(0,i.kt)("inlineCode",{parentName:"p"},"7776000")," seconds, then if you need to refresh the token more than 90 days from right now, the user will probably need to log in again."),(0,i.kt)("h2",{id:"using-the-access-token"},"using the access token"),(0,i.kt)("p",null,"the ",(0,i.kt)("inlineCode",{parentName:"p"},"access\xa0token")," is sent along with each ",(0,i.kt)("a",{parentName:"p",href:"/api/privacy"},"private")," request as an HTTP header.",(0,i.kt)("br",{parentName:"p"}),"\n","the header's name is",(0,i.kt)("br",{parentName:"p"}),"\n",(0,i.kt)("inlineCode",{parentName:"p"},"Authorization"),(0,i.kt)("br",{parentName:"p"}),"\n","and its value looks like",(0,i.kt)("br",{parentName:"p"}),"\n",(0,i.kt)("inlineCode",{parentName:"p"},"Bearer Jq+R9ULSA1VWPGB/TBTDcuUcFJiI2Du/Cj8KUkQqkyXFGsAwwT7MakG/3ntvZNHrPHz="),(0,i.kt)("br",{parentName:"p"}),"\n",'that\'s "Bearer", then a space, then the token.'),(0,i.kt)("h2",{id:"refreshing-the-access-token"},"refreshing the access token"),(0,i.kt)("p",null,"refreshing the access token uses the same endpoint as issuing it:",(0,i.kt)("br",{parentName:"p"}),"\n",(0,i.kt)("inlineCode",{parentName:"p"},"https://www.bungie.net/platform/app/oauth/token/")),(0,i.kt)("p",null,"once again, you'll send a form-encoded POST request to the endpoint, with similar fields"),(0,i.kt)("ul",null,(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"grant_type"),' - always "refresh_token". just those 2 literal words and an underscore '),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"refresh_token")," - the ",(0,i.kt)("inlineCode",{parentName:"li"},"refresh_token")," you set aside earlier "),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"client_id")," - from your ",(0,i.kt)("a",{parentName:"li",href:"/api/app-setup"},"application's details")),(0,i.kt)("li",{parentName:"ul"},(0,i.kt)("inlineCode",{parentName:"li"},"client_secret")," - from your ","[application's details]","(/api/app-setup")),(0,i.kt)("div",{className:"admonition admonition-caution alert alert--warning"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"}))),"important")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},(0,i.kt)("strong",{parentName:"p"},"when you refresh tokens"),", use ",(0,i.kt)("strong",{parentName:"p"},"all")," the new response fields and ",(0,i.kt)("strong",{parentName:"p"},"discard any old data"),". the expiration timeframes are updated to apply for the time ",(0,i.kt)("strong",{parentName:"p"},"now"),", and they apply to the new tokens"))),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"huh ???")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},(0,i.kt)("strong",{parentName:"p"},'"what refresh token? i don\'t have one, only an access token."'),(0,i.kt)("br",{parentName:"p"}),"\n","you probably selected Public in your ",(0,i.kt)("a",{parentName:"p",href:"/api/app-setup"},"application settings")))))}h.isMDXComponent=!0}}]);